#!/usr/bin/env python

#import json
import os
import subprocess
import sys
import ConfigParser


def test_cmd(cmd):
    try:
        return subprocess.check_output([__file__] + cmd.split(' '))
    except subprocess.CalledProcessError as err:
        sys.stderr.write('FAIL: %s\n' % ' '.join(err.cmd))
        sys.stderr.write('      %s\n' % err.output)
        sys.exit(1)


def resolve(path):
    if os.path.islink(path):
        path = os.path.join(os.path.dirname(path), os.readlink(path))
        return resolve(path)
    return path

PHANTOMJS_NATIVE_ARGS = [
    'cookies-file',
    'config',
    'debug',
    'disk-cache',
    'ignore-ssl-errors',
    'load-images',
    'load-plugins',
    'local-storage-path',
    'local-storage-quota',
    'local-to-remote-url-access',
    'max-disk-cache-size',
    'output-encoding',
    'proxy',
    'proxy-auth',
    'proxy-type',
    'remote-debugger-port',
    'remote-debugger-autorun',
    'script-encoding',
    'web-security',
]
SPECTER_ARGS = []
SPECTER_PATH = os.path.abspath(os.path.join(os.path.dirname(resolve(__file__)), '..'))
PHANTOMJS_ARGS = []
SYS_ARGS = sys.argv[1:]

conf = {
        'baseline': './screenshots',
        'diff': '/tmp/specter/diff',
        'fail': '/tmp/specter/fail',
    }

rc_files = []

apath = os.getcwd()
while apath != '/':
    if os.path.isfile(os.path.join(apath, '.specterrc')):
        rc_files.append(os.path.join(apath, '.specterrc'))
    apath = os.path.dirname(apath)
if os.path.isfile(os.path.join(os.path.sep, 'etc', 'specterrc')):
    rc_files.append(os.path.join(os.path.sep, 'etc', 'specterrc'))

while rc_files:
    with open(rc_files.pop()) as f:
        cp = ConfigParser.SafeConfigParser()
        cp.readfp(f)
        for k in conf.keys():
            try:
                conf[k] = cp.get('paths', k)
            except ConfigParser.NoSectionError as err:
                pass
            except ConfigParser.NoOptionError as err:
                pass

#print conf

for arg in SYS_ARGS:
    found = False
    for native in PHANTOMJS_NATIVE_ARGS:
        if arg.startswith('--%s' % native):
            PHANTOMJS_ARGS.append(arg)
            found = True
    if not found:
        SPECTER_ARGS.append(arg)


TESTRUNNER = ['casperjs']
TESTRUNNER.extend([
    '--specter-path=%s' % SPECTER_PATH,
    '--baseline=%s' % conf['baseline'],
    '--diffdir=%s' % conf['diff'],
    '--faildir=%s' % conf['fail'],
    os.path.join(SPECTER_PATH, 'bin', 'testrunner.js'),
])
TESTRUNNER.extend(SPECTER_ARGS)

try:
    #print ' '.join(TESTRUNNER)
    subprocess.call(TESTRUNNER)
except OSError as err:
    print('Fatal: %s; check your requirements')
    sys.exit(1)


COMPARE_COMMAND = ['casperjs']
COMPARE_COMMAND.extend(PHANTOMJS_ARGS)
COMPARE_COMMAND.extend([
    '--specter-path=%s' % SPECTER_PATH,
    '--baseline=%s' % conf['baseline'],
    '--diffdir=%s' % conf['diff'],
    '--faildir=%s' % conf['fail'],
    os.path.join(SPECTER_PATH, 'bin', 'compare.js'),
])
COMPARE_COMMAND.extend(SPECTER_ARGS)

try:
    #print ' '.join(COMPARE_COMMAND)
    subprocess.call(COMPARE_COMMAND)
except OSError as err:
    print(('Fatal: %s; check your requirements' % err))
    sys.exit(1)
